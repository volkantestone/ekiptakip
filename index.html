<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ekip Takip Pro (V48 - Mod√ºler)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4facfe">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Ekip Takip">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary-grad: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --bg-color: #f3f5f9; --text-main: #2d3436; --nav-height: 75px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); margin: 0; padding: 0; padding-bottom: 120px; color: var(--text-main); }
        .hidden { display: none !important; } 
        .admin-only { display: none; } 
        .view-section { display: none; animation: fadeIn 0.3s; } 
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: none; padding: 15px 20px; border-radius: 10px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideInRight 0.3s; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .toast-success { background: #27ae60; }
        .toast-error { background: #e74c3c; }
        .app-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-icons { display: flex; align-items: center; gap: 10px; position: relative; }
        .icon-btn { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; font-size: 1.2rem; position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: none; justify-content: center; align-items: center; border: 2px solid white; }
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 600px; background: white; height: var(--nav-height); border-radius: 25px; display: flex; align-items: center; box-shadow: 0 15px 35px rgba(0,0,0,0.15); z-index: 1000; overflow-x: auto; padding: 0 10px; gap: 15px; -ms-overflow-style: none; scrollbar-width: none; white-space: nowrap; cursor: grab; user-select: none; }
        .bottom-nav:active { cursor: grabbing; }
        .bottom-nav::-webkit-scrollbar { display: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; color: #b2bec3; min-width: 60px; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
        .nav-item .icon { font-size: 1.5rem; margin-bottom: 2px; pointer-events: none; }
        .nav-item.active { color: #764ba2; transform: translateY(-3px); font-weight: 600; }
        #notification-dropdown { position: absolute; top: 60px; right: 0; width: 300px; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 2500; display: none; overflow: hidden; border: 1px solid #eee; }
        .notif-header { background: #f8f9fa; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .notif-list { max-height: 300px; overflow-y: auto; }
        .notif-item { padding: 10px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .notif-empty { padding: 20px; text-align: center; color: #aaa; font-size: 0.9rem; }
        .container { max-width: 1100px; margin: 0 auto; padding: 0 15px; }
        .modern-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .hero-card { background: var(--primary-grad); border-radius: 25px; padding: 25px; color: white; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(118, 75, 162, 0.3); }
        .hero-stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
        .hero-stat-item span { font-size: 1.8rem; font-weight: 700; display: block; }
        .search-bar { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1px solid #eee; background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23ccc" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat right 15px center; margin-bottom: 15px; font-size: 0.9rem; }
        .info-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .info-card.active { border-left-color: #27ae60; } .info-card.busy { border-left-color: #e74c3c; } .info-card.custody { border-left-color: #f39c12; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #d1fae5; color: #065f46; } .badge-red { background: #fee2e2; color: #991b1b; } .badge-orange { background: #ffedd5; color: #9a3412; } .badge-gray { background: #f3f4f6; color: #374151; }
        .calendar-nav-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-head { text-align: center; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .day-cell { background: #f8f9fa; min-height: 80px; border-radius: 8px; padding: 4px; font-size: 0.8rem; position: relative; cursor: pointer; display: flex; flex-direction: column; overflow: hidden; }
        .day-cell b { align-self: center; margin-bottom: 4px; color: #333; }
        .day-cell.today { border: 2px solid #764ba2; background: white; }
        .task-dot { font-size: 0.6rem; background: #e0e7ff; color: #4338ca; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        input, select { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px; font-size: 16px; outline: none; }
        textarea { width: 100%; padding: 12px; border: 1px solid #eee; background: #f9f9f9; border-radius: 10px; outline: none; margin-bottom: 10px; min-height: 100px; resize: vertical; }
        .btn-main { width: 100%; padding: 12px; background: var(--primary-grad); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; margin-bottom: 5px; transition: opacity 0.3s; }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; margin-left: 5px; }
        .filter-btn { padding: 8px 15px; border: 1px solid #eee; border-radius: 20px; background: #fff; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary-grad); color: white; border: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: end; }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto; }
        #month-picker-modal { display: none; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 300px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 500; padding: 15px; }
        .year-selector { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .month-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .month-btn { padding: 10px; background: #f9f9f9; text-align: center; cursor: pointer; border-radius: 5px; font-size: 0.8rem; }
        .multi-select-area { background: #f9f9f9; border: 1px solid #eee; border-radius: 10px; padding: 10px; max-height: 150px; overflow-y: auto; margin-bottom: 10px; }
        .ms-item { display: flex; align-items: center; margin-bottom: 8px; } .ms-item input { width: 20px; margin: 0 10px 0 0; }
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .log-table th { text-align: left; padding: 10px; background: #f4f6f8; }
        .log-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .avatar { width: 40px; height: 40px; background: #eee; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; margin-right:10px;}
        .person-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .leave-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 8px 0; font-size: 0.9rem; }
        .report-controls { display: flex; gap: 5px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 10px; }
        .report-controls select { margin-bottom: 0; font-size: 0.8rem; padding: 8px; }
        .feedback-item { background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 0.85rem; }
        .feedback-item strong { color: #764ba2; }
        .feedback-date { float: right; color: #aaa; font-size: 0.75rem; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="app-screen">
    <div class="app-header">
        <div><small style="color:#888;">Merhaba,</small><h2 style="margin:0;" id="welcomeUser">Kullanƒ±cƒ±</h2></div>
        
        <div class="header-icons">
            <button class="icon-btn" onclick="openFeedbackModal()" title="Geri Bildirim Yap">üí¨</button>
            <button class="icon-btn" onclick="toggleNotifications()">
                üîî <span id="notif-badge" class="notif-badge">0</span>
            </button>
            <button class="icon-btn" onclick="handleLogout()">üö™</button>
            
            <div id="notification-dropdown">
                <div class="notif-header">
                    <span>Bildirimler</span>
                    <button onclick="clearAllNotifications()" style="background:none; border:none; color:#e74c3c; font-size:0.7rem; cursor:pointer;">Temizle</button>
                </div>
                <div id="notif-list" class="notif-list"><div class="notif-empty">Bildirim yok.</div></div>
            </div>
        </div>
    </div>

    <div class="container">
        
        <div id="view-calendar" class="view-section active">
            <div class="hero-card">
                <div class="hero-stat-grid">
                    <div class="hero-stat-item"><span id="stat-total">0</span><small>Ekip</small></div>
                    <div class="hero-stat-item"><span id="stat-active">0</span><small>Sahada</small></div>
                    <div class="hero-stat-item"><span id="stat-idle">0</span><small>Bo≈üta</small></div>
                </div>
            </div>
            <div class="modern-card">
                <div class="calendar-nav-row">
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(-1)">‚óÄ</button>
                    <div style="position:relative; text-align:center;">
                        <h3 style="margin:0; cursor:pointer; text-decoration:underline;" id="monthDisplay" onclick="toggleDatePicker()">Takvim</h3>
                        <div id="month-picker-modal">
                            <div class="year-selector"><button onclick="changePickYear(-1)">‚óÄ</button><span id="pick-year-val">2025</span><button onclick="changePickYear(1)">‚ñ∂</button></div>
                            <div class="month-grid">
                                <div class="month-btn" onclick="goToMonth(0)">Oca</div><div class="month-btn" onclick="goToMonth(1)">≈ûub</div><div class="month-btn" onclick="goToMonth(2)">Mar</div>
                                <div class="month-btn" onclick="goToMonth(3)">Nis</div><div class="month-btn" onclick="goToMonth(4)">May</div><div class="month-btn" onclick="goToMonth(5)">Haz</div>
                                <div class="month-btn" onclick="goToMonth(6)">Tem</div><div class="month-btn" onclick="goToMonth(7)">Aƒüu</div><div class="month-btn" onclick="goToMonth(8)">Eyl</div>
                                <div class="month-btn" onclick="goToMonth(9)">Eki</div><div class="month-btn" onclick="goToMonth(10)">Kas</div><div class="month-btn" onclick="goToMonth(11)">Ara</div>
                            </div>
                        </div>
                    </div>
                    <button class="icon-btn" style="width:35px; height:35px;" onclick="changeMonth(1)">‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>
        </div>

        <div id="view-projects" class="view-section">
            <input type="text" class="search-bar" placeholder="Proje Ara..." onkeyup="filterList(this, 'projectListBody', 'div')">
            <div class="admin-only modern-card" id="projectFormContainer">
                <h3 id="projectFormTitle">Yeni Proje</h3>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <select id="p-manager"></select>
                <div style="display:flex; gap:5px;">
                    <div style="flex:1"><label style="font-size:0.7rem;">Ba≈ülangƒ±√ß</label><input type="date" id="p-start"></div>
                    <div style="flex:1"><label style="font-size:0.7rem;">Biti≈ü</label><input type="date" id="p-end"></div>
                </div>
                <div style="display:flex; gap:5px;"><input type="number" id="p-cost" placeholder="Maliyet"><input type="number" id="p-offer" placeholder="Teklif"></div>
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-p-save" onclick="submitProject()">Kaydet</button>
                    <button class="btn-main" id="btn-p-update" onclick="updateProjectDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-p-cancel" onclick="cancelProjectEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card" id="projectListBody"></div>
        </div>

        <div id="view-team" class="view-section">
            <input type="text" class="search-bar" placeholder="Personel Ara..." onkeyup="filterList(this, 'teamListArea', 'div.person-row')">
            <div class="modern-card" id="teamListArea"></div>
        </div>

        <div id="view-vehicles" class="view-section">
            <input type="text" class="search-bar" placeholder="Plaka/Model Ara..." onkeyup="filterList(this, 'vehicleListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="vehicleFormContainer">
                <h3 id="vehicleFormTitle">Yeni Ara√ß</h3>
                <input type="text" id="v-plate" placeholder="Plaka">
                <input type="text" id="v-info" placeholder="Model">
                <label>Muayene Tarihi:</label><input type="date" id="v-inspection">
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-v-save" onclick="addVehicle()">Kaydet</button>
                    <button class="btn-main" id="btn-v-update" onclick="updateVehicleDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-v-cancel" onclick="cancelVehicleEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card"><div id="vehicleListArea" class="card-list"></div></div>
        </div>

        <div id="view-devices" class="view-section">
            <input type="text" class="search-bar" placeholder="Cihaz/Seri No Ara..." onkeyup="filterList(this, 'deviceListArea', 'div.info-card')">
            <div class="admin-only modern-card" id="deviceFormContainer">
                <h3 id="deviceFormTitle">Yeni Cihaz</h3>
                <input type="text" id="d-name" placeholder="Cihaz Adƒ±">
                <input type="text" id="d-serial" placeholder="Seri No">
                <label>Kalibrasyon Tarihi:</label><input type="date" id="d-calib">
                <label style="margin-top:10px; display:block; font-size:0.8rem;">Kalibrasyon Dosyasƒ± (PDF):</label>
                <input type="file" id="d-file" accept="application/pdf" style="background:white; margin-top:5px;">
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <button class="btn-main" id="btn-d-save" onclick="addDevice()">Ekle</button>
                    <button class="btn-main" id="btn-d-update" onclick="updateDeviceDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-d-cancel" onclick="cancelDeviceEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card"><div id="deviceListArea" class="card-list"></div></div>
        </div>

        <div id="view-users" class="view-section">
            <div class="admin-only modern-card">
                <h3 id="userFormTitle">Kullanƒ±cƒ± Y√∂netimi</h3>
                <input type="text" id="u-name" placeholder="Ad Soyad">
                <input type="text" id="u-title" placeholder="√únvan">
                <input type="email" id="u-email" placeholder="E-Posta">
                <input type="tel" id="u-phone" placeholder="Tel (√ñrn: 90532xxxxxxx)">
                <select id="u-role"><option value="staff">Personel</option><option value="admin">Y√∂netici</option></select>
                <div style="display:flex; gap:5px;">
                    <button class="btn-main" id="btn-user-add" onclick="addUserToDB()">Ekle</button>
                    <button class="btn-main" id="btn-user-update" onclick="updateUserDB()" style="background:#f39c12; display:none;">G√ºncelle</button>
                    <button class="btn-main" id="btn-user-cancel" onclick="cancelUserEdit()" style="background:#95a5a6; display:none;">Vazge√ß</button>
                </div>
            </div>
            <div class="modern-card" id="userListArea"></div>
        </div>

        <div id="view-reports" class="view-section">
            <div class="modern-card">
                <label>D√∂nem:</label>
                <input type="month" id="reportDateSelector" onchange="filterReports()" style="width:100%;">
            </div>
            <div class="modern-card">
                <h3>Zimmet Ge√ßmi≈üi</h3>
                <div class="report-filters" style="display:flex; gap:5px; margin-bottom:10px;">
                    <button class="filter-btn active" onclick="setReportFilter('all', this)">T√ºm√º</button>
                    <button class="filter-btn" onclick="setReportFilter('vehicle', this)">Ara√ß</button>
                    <button class="filter-btn" onclick="setReportFilter('device', this)">Cihaz</button>
                </div>
                <div style="max-height:300px; overflow-y:auto;">
                    <table class="log-table" id="logTable" style="width:100%; font-size:0.8rem;"></table>
                </div>
            </div>
             <div class="modern-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Personel Eforu</h3>
                    <button class="btn-sm" style="background:#27ae60; color:white; border:none; border-radius:5px; cursor:pointer;" onclick="exportExcel()">Excel ƒ∞ndir</button>
                </div>
                <table class="log-table" id="personnelReportTable" style="width:100%;"><tbody id="personnelReportBody"></tbody></table>
            </div>
        </div>

        <div id="view-logs" class="view-section">
            <div class="modern-card admin-only">
                <h3>Kullanƒ±cƒ± Geri Bildirimleri</h3>
                <div style="max-height:200px; overflow-y:auto;" id="adminFeedbackList">
                    <p style="color:#aaa; text-align:center;">Y√ºkleniyor...</p>
                </div>
            </div>
            <div class="modern-card">
                <h3>Sistem Kayƒ±tlarƒ± (Log)</h3>
                <label>Tarih Se√ß:</label>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="date" id="adminLogDate" onchange="renderAdminLogs(this.value)">
                    <button class="btn-sm" onclick="exportLogsToWord()" style="background:#2980b9; color:white;">Word ƒ∞ndir</button>
                </div>
                <div style="overflow-x:auto;" id="adminLogContainer">
                    <table class="log-table" id="adminLogTable" style="width:100%;">
                        <thead><tr><th>Tarih</th><th>Kullanƒ±cƒ±</th><th>ƒ∞≈ülem</th><th>Detay</th></tr></thead>
                        <tbody id="adminLogBody"><tr><td colspan="4">Tarih se√ßiniz.</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-leaves" class="view-section">
            <div class="modern-card">
                <h3>Personel ƒ∞zin Durumu & Rapor</h3>
                <div class="report-controls">
                    <select id="pdfYear" style="flex:1;"><option value="2025">2025</option><option value="2024">2024</option></select>
                    <select id="pdfMonth" style="flex:1;">
                        <option value="all">T√ºm Yƒ±l</option>
                        <option value="01">Ocak</option><option value="02">≈ûubat</option><option value="03">Mart</option>
                        <option value="04">Nisan</option><option value="05">Mayƒ±s</option><option value="06">Haziran</option>
                        <option value="07">Temmuz</option><option value="08">Aƒüustos</option><option value="09">Eyl√ºl</option>
                        <option value="10">Ekim</option><option value="11">Kasƒ±m</option><option value="12">Aralƒ±k</option>
                    </select>
                </div>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <button onclick="downloadLeavePDF('year')" class="btn-sm" style="flex:1; background:#764ba2; color:white;">üìÇ Yƒ±llƒ±k PDF</button>
                    <button onclick="downloadLeavePDF('month')" class="btn-sm" style="flex:1; background:#667eea; color:white;">üìÑ Aylƒ±k PDF</button>
                </div>
                <div id="allUserLeavesStats">
                    <p style="text-align:center; color:#888;">Y√ºkleniyor...</p>
                </div>
            </div>
            <div class="modern-card">
                <h3>ƒ∞zin Talep Olu≈ütur</h3>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label style="font-size:0.8rem;">Ba≈ülangƒ±√ß</label><input type="date" id="l-start"></div>
                    <div style="flex:1;"><label style="font-size:0.8rem;">Biti≈ü</label><input type="date" id="l-end"></div>
                </div>
                <label style="font-size:0.8rem;">ƒ∞zin T√ºr√º:</label>
                <select id="l-type">
                    <option value="Yƒ±llƒ±k ƒ∞zin">Yƒ±llƒ±k ƒ∞zin</option>
                    <option value="Mazeret ƒ∞zni">Mazeret ƒ∞zni</option>
                    <option value="Rapor">Rapor (Hastalƒ±k)</option>
                    <option value="√úcretli ƒ∞zin">√úcretli ƒ∞zin</option>
                    <option value="√úcretsiz ƒ∞zin">√úcretsiz ƒ∞zin</option>
                    <option value="√ñl√ºm ƒ∞zni">√ñl√ºm ƒ∞zni</option>
                    <option value="Evlilik ƒ∞zni">Evlilik ƒ∞zni</option>
                    <option value="Babalƒ±k ƒ∞zni">Babalƒ±k ƒ∞zni</option>
                </select>
                <input type="text" id="l-desc" placeholder="A√ßƒ±klama (Opsiyonel)">
                <div style="background:#fff3cd; padding:10px; border-radius:8px; margin-bottom:10px; display:none; color:#856404;" id="leaveCalcInfo"></div>
                <button class="btn-main" onclick="saveLeaveRequest()">Talep Olu≈ütur</button>
            </div>
            <div class="modern-card">
                <h3>ƒ∞zin Ge√ßmi≈üi</h3>
                <div id="leaveListArea"></div>
            </div>
        </div>

        <div id="view-profile" class="view-section">
            <div class="modern-card">
                <h3>Profilim</h3>
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="width:80px; height:80px; background:#764ba2; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; margin:0 auto;" id="profileAvatar">?</div>
                    <h2 id="profileName" style="margin:10px 0 5px 0;">-</h2>
                    <p id="profileRole" style="color:#888; margin:0;">-</p>
                </div>
                <div style="border-top:1px solid #eee; padding-top:15px;">
                    <h4>≈ûifre Deƒüi≈ütir</h4>
                    <input type="password" id="new-pass" placeholder="Yeni ≈ûifre">
                    <input type="password" id="new-pass-confirm" placeholder="Yeni ≈ûifre (Tekrar)">
                    <button class="btn-main" onclick="updateUserPassword()">≈ûifreyi G√ºncelle</button>
                </div>
            </div>
        </div>

    </div>

    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" onclick="switchTab('calendar')"><span class="icon">üìÖ</span>Takvim</div>
        <div class="nav-item" onclick="switchTab('projects')"><span class="icon">üìÇ</span>Proje</div>
        <div class="nav-item" onclick="switchTab('team')"><span class="icon">üë•</span>Ekip</div>
        <div class="nav-item" onclick="switchTab('vehicles')"><span class="icon">üöó</span>Ara√ß</div>
        <div class="nav-item" onclick="switchTab('devices')"><span class="icon">üß∞</span>Cihaz</div>
        <div class="nav-item" onclick="switchTab('leaves')"><span class="icon">üèñÔ∏è</span>ƒ∞zin</div>
        <div class="nav-item admin-only" onclick="switchTab('users')"><span class="icon">‚öôÔ∏è</span>Yetki</div>
        <div class="nav-item admin-only" onclick="switchTab('reports')"><span class="icon">üìä</span>Rapor</div>
        <div class="nav-item admin-only" onclick="switchTab('logs')"><span class="icon">üìù</span>Log</div>
        <div class="nav-item" onclick="switchTab('profile')"><span class="icon">üë§</span>Profil</div>
    </div>
</div>

<div class="modal-overlay" id="custodyModal" onclick="if(event.target===this) closeCustodyModal()">
    <div class="modal-card">
        <h3>Zimmetle</h3>
        <p id="custodyItemName" style="color:#666;"></p>
        <label>Personel Se√ß:</label><select id="c-person"></select>
        <button class="btn-main" onclick="saveCustody()">Kaydet</button>
        <button class="btn-main" onclick="closeCustodyModal()" style="background:#95a5a6; margin-top:10px;">ƒ∞ptal</button>
    </div>
</div>

<div class="modal-overlay" id="taskModal" onclick="if(event.target===this) closeModal()">
    <div class="modal-card">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h2>G√∂revler</h2><span onclick="closeModal()" style="font-size:1.5rem; cursor:pointer;">‚úï</span></div>
        <p id="modalDateText" style="margin-bottom:10px; font-weight:bold; color:#764ba2;"></p>
        <div id="dayTaskList" style="margin-bottom:20px;"></div>
        <div class="admin-only">
            <h3 id="taskFormTitle">Yeni Atama</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Ba≈ülangƒ±√ß</label><input type="date" id="t-start-date"></div>
                <div style="flex:1;"><label>Biti≈ü</label><input type="date" id="t-end-date"></div>
            </div>
            <label>Personel</label><div class="multi-select-area" id="ms-person"></div>
            <label>Proje</label><select id="t-project-select"></select>
            <input type="text" id="t-loc" placeholder="Konum">
            <label>Ara√ßlar</label><div class="multi-select-area" id="ms-plate"></div>
            <label>Cihazlar</label><div class="multi-select-area" id="ms-device"></div>
            <div id="conflictWarning" style="color:red; font-size:0.8rem; margin:10px 0;"></div>
            <button class="btn-main" id="btn-save-task" onclick="saveTask()">Kaydet</button>
            <button class="btn-main" id="btn-cancel-task" onclick="cancelTaskEdit()" style="background:#95a5a6; display:none; margin-top:5px;">Vazge√ß</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="feedbackModal" onclick="if(event.target===this) closeFeedbackModal()">
    <div class="modal-card">
        <h3>Geri Bildirim G√∂nder</h3>
        <p style="color:#666; font-size:0.9rem;">Uygulama ile ilgili g√∂r√º≈ü, √∂neri veya ≈üikayetlerinizi yazabilirsiniz.</p>
        <textarea id="feedbackText" placeholder="Mesajƒ±nƒ±z..."></textarea>
        <button class="btn-main" onclick="submitFeedback()">G√∂nder</button>
        <button class="btn-main" onclick="closeFeedbackModal()" style="background:#95a5a6; margin-top:10px;">Vazge√ß</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Firebase Ayarlarƒ±
    const k1 = "AIzaSyD4XZR8JAMe-"; const k2 = "Qr2Oj2UGnp9mFc8En38gxY";
    const firebaseConfig = {
      apiKey: k1 + k2,
      authDomain: "ekiptakipapp.firebaseapp.com",
      projectId: "ekiptakipapp",
      storageBucket: "ekiptakipapp.firebasestorage.app",
      messagingSenderId: "55716082808",
      appId: "1:55716082808:web:b144b953684fc9f80c698d",
      measurementId: "G-S6Q0H5RHR7"
    };

    // Firebase Ba≈ülatma ve Window'a Aktarma
    // (B√∂ylece diƒüer script etiketleri bunlara eri≈üebilir)
    const app = initializeApp(firebaseConfig);
    window.auth = getAuth(app);
    window.db = getFirestore(app);
    window.storage = getStorage(app); 
    
    // Firestore Fonksiyonlarƒ±nƒ± da dƒ±≈üa a√ßƒ±yoruz (Diƒüer scriptlerde kullanmak i√ßin)
    window.fs = { collection, addDoc, deleteDoc, updateDoc, doc, onSnapshot, query, orderBy, setDoc, getDoc, limit, where, writeBatch };
    window.fbStorage = { ref, uploadBytes, getDownloadURL };
    window.fbAuth = { signOut, updatePassword, onAuthStateChanged };

    // Global Deƒüi≈ükenler
    window.globalState = {
        projects: [], tasks: [], users: [], vehicles: [], devices: [], logs: [], notifications: [], leaves: [],
        currentUser: null, userRole: 'staff',
        currentDate: new Date(),
        selectedDateStr: null,
        pickerYear: new Date().getFullYear(),
        editingUserEmail: null, editingVehicleId: null, editingDeviceId: null, editingProjectId: null, editingTaskId: null,
        custodyTargetId: null, custodyType: null,
        currentReportFilter: 'all',
        currentReportDate: new Date().toISOString().slice(0, 7)
    };
    
    // Yardƒ±mcƒ± Tarih Fonksiyonu
    window.getCurrentDateStr = () => { const d=new Date(); return `${d.getDate()}-${d.getMonth()}-${d.getFullYear()}`; }
    window.globalState.selectedDateStr = window.getCurrentDateStr();
</script>

<script type="module">
    window.showToast = (msg, type = "success") => {
        const t = document.getElementById("toast-container");
        t.innerText = msg;
        t.className = type === "success" ? "toast-success" : "toast-error";
        t.style.display = "block";
        setTimeout(() => { t.style.display = "none"; }, 3000);
    }

    window.parseDateStr = (str) => { if(!str) return new Date(); const parts = str.split('-'); return new Date(parts[2], parts[1], parts[0]); }
    
    window.filterList = (input, listId, itemTag) => {
        const filter = input.value.toLowerCase();
        const list = document.getElementById(listId);
        const items = list.querySelectorAll(itemTag);
        items.forEach(item => {
            const text = item.textContent || item.innerText;
            item.style.display = text.toLowerCase().indexOf(filter) > -1 ? "" : "none";
        });
    }

    // Excel Export
    window.exportExcel = () => {
        if (typeof XLSX === 'undefined') return alert("Excel k√ºt√ºphanesi y√ºklenemedi.");
        const [year, month] = window.globalState.currentReportDate.split('-').map(Number);
        const reportData = [];
        window.globalState.users.forEach(u => {
            let days = 0;
            window.globalState.tasks.forEach(t => {
                let start = new Date(t.startDate || window.parseDateStr(t.date));
                let end = new Date(t.endDate || window.parseDateStr(t.date));
                let loop = new Date(start);
                while(loop <= end) {
                    if (loop.getFullYear() === year && loop.getMonth() === (month - 1)) {
                         if (Array.isArray(t.person)) { if(t.person.includes(u.name)) days++; }
                         else if(t.person === u.name) days++;
                    }
                    loop.setDate(loop.getDate() + 1);
                }
            });
            reportData.push({ "Personel": u.name, "√áalƒ±≈üma G√ºn√º": days });
        });
        const ws = XLSX.utils.json_to_sheet(reportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Efor");
        XLSX.writeFile(wb, `Personel_Efor_${window.globalState.currentReportDate}.xlsx`);
    }
</script>

<script type="module">
    // Takvim Render
    window.renderCalendar = () => {
        const grid = document.getElementById('calendarGrid'); 
        grid.innerHTML = `<div class="day-head">Pt</div><div class="day-head">Sa</div><div class="day-head">√áa</div><div class="day-head">Pe</div><div class="day-head">Cu</div><div class="day-head">Ct</div><div class="day-head">Pz</div>`;
        const y = window.globalState.currentDate.getFullYear(), m = window.globalState.currentDate.getMonth();
        const names = ["Ocak", "≈ûubat", "Mart", "Nisan", "Mayƒ±s", "Haziran", "Temmuz", "Aƒüustos", "Eyl√ºl", "Ekim", "Kasƒ±m", "Aralƒ±k"];
        document.getElementById('monthDisplay').innerText = `${names[m]} ${y}`;
        const first = new Date(y, m, 1).getDay(), start = first===0?6:first-1, days = new Date(y, m+1, 0).getDate();
        for(let i=0; i<start; i++) grid.innerHTML+='<div></div>';
        const todayObj = new Date();
        const todayISO = todayObj.toISOString().split('T')[0];
        for(let d=1; d<=days; d++) {
            const cellDate = new Date(y, m, d);
            const offset = cellDate.getTimezoneOffset();
            const cellISO = new Date(cellDate.getTime() - (offset*60*1000)).toISOString().split('T')[0];
            let dots = "";
            window.globalState.tasks.forEach(t => {
                const s = t.startDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                if (cellISO >= s && cellISO <= e) {
                    if(Array.isArray(t.person)) t.person.forEach(p => dots += `<span class="task-dot">${p}</span>`);
                    else dots += `<span class="task-dot">${t.person}</span>`;
                }
            });
            let cls = (cellISO === todayISO) ? "day-cell today" : "day-cell";
            grid.innerHTML += `<div class="${cls}" onclick="openModal('${cellISO}')"><b>${d}</b>${dots}</div>`;
        }
    }

    // Listeleri Render Etme
    window.renderProjects = () => {
        document.getElementById('projectListBody').innerHTML=window.globalState.projects.map(p=>{
            const pf=p.offer-p.cost; 
            return `<div style="padding:15px; border-bottom:1px solid #eee;"><strong>${p.name}</strong> (${p.start||'-'} / ${p.end||'?'})<br><small>${p.manager||'-'} | Kar: ${pf}</small> ${window.globalState.userRole==='admin' ? `<div style="float:right;"><button onclick="editProject('${p.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteProject('${p.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div>`;
        }).join('');
    }

    window.renderVehicleList = () => {
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('vehicleListArea').innerHTML = window.globalState.vehicles.map(v => { 
            let inspHtml = v.inspectionDate ? (new Date(v.inspectionDate) < new Date() ? `<small style="color:red; display:block;">‚ö†Ô∏è Muayene: ${v.inspectionDate}</small>` : `<small style="color:#666;">üìÖ Muayene: ${v.inspectionDate}</small>`) : ""; 
            let statusBadge = `<span class="badge badge-green">BO≈ûTA</span>`;
            let zimmetHtml = ""; 
            if(v.currentHolder) { 
                statusBadge = `<span class="badge badge-orange">üë§ ${v.currentHolder}</span>`; 
                if(window.globalState.userRole==='admin') zimmetHtml = `<button class="btn-sm btn-outline-red" onclick="returnItem('vehicle','${v.id}')">ƒ∞ade Al</button>`; 
            } else if(window.globalState.userRole==='admin') { 
                zimmetHtml = `<button class="btn-sm btn-outline-blue" onclick="openCustodyModal('vehicle','${v.id}','${v.plate}','${v.info || ''}')">Zimmetle</button>`; 
            } 
            const at = window.globalState.tasks.find(t => {
                const s = t.startDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                const inRange = todayISO >= s && todayISO <= e;
                const hasPlate = Array.isArray(t.plate) ? t.plate.includes(v.plate) : t.plate === v.plate;
                return inRange && hasPlate;
            });
            if(at) statusBadge += ` <span class="badge badge-red" style="margin-left:5px">G√ñREVDE</span>`;
            return `<div class="info-card ${v.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${v.plate}</strong><br><small>${v.info || ''}</small>${inspHtml}</div>${window.globalState.userRole==='admin' ? `<div><button onclick="editVehicle('${v.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteVehicle('${v.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">${statusBadge}${zimmetHtml}</div></div>`; 
        }).join('');
    }

    window.renderDeviceList = () => {
        const todayISO = new Date().toISOString().split('T')[0];
        document.getElementById('deviceListArea').innerHTML = window.globalState.devices.map(d => { 
            let statusBadge = `<span class="badge badge-green">BO≈ûTA</span>`, zimmetHtml = ""; 
            if(d.currentHolder) { 
                statusBadge = `<span class="badge badge-orange">üë§ ${d.currentHolder}</span>`; 
                if(window.globalState.userRole==='admin') zimmetHtml = `<button class="btn-sm btn-outline-red" onclick="returnItem('device','${d.id}')">ƒ∞ade Al</button>`; 
            } else if(window.globalState.userRole==='admin') { 
                zimmetHtml = `<button class="btn-sm btn-outline-blue" onclick="openCustodyModal('device','${d.id}','${d.name}', '${d.serial || ''}')">Zimmetle</button>`; 
            } 
            const at = window.globalState.tasks.find(t => {
                const s = t.startDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                const e = t.endDate || window.parseDateStr(t.date).toISOString().split('T')[0];
                const inRange = todayISO >= s && todayISO <= e;
                const hasDev = Array.isArray(t.device) ? t.device.includes(d.name) : t.device === d.name;
                return inRange && hasDev;
            });
            if(at) statusBadge += ` <span class="badge badge-red" style="margin-left:5px">G√ñREVDE</span>`; 
            let calibHtml = d.calib ? `<br><small style="color:${new Date(d.calib) < new Date() ? 'red' : '#666'}">Kalibrasyon: ${d.calib}</small>` : ""; 
            let pdfButton = "";
            if (d.pdfUrl) { pdfButton = `<a href="${d.pdfUrl}" target="_blank" style="text-decoration:none; margin-left:10px; font-size:0.8rem; background:#3498db; color:white; padding:3px 8px; border-radius:5px;">üìÑ ƒ∞ndir</a>`; } 
            else { pdfButton = `<small style="color:#aaa; margin-left:10px;">(Dosya Yok)</small>`; }
            return `<div class="info-card ${d.currentHolder?'custody':'active'}"><div class="info-card-header"><div><strong>${d.name}</strong> <small>(${d.serial || '-'})</small> ${pdfButton} ${calibHtml}</div>${window.globalState.userRole==='admin' ? `<div><button onclick="editDevice('${d.id}')" style="border:none; bg:none; font-size:1.1rem;">‚úé</button><button onclick="deleteDevice('${d.id}')" style="color:red; border:none; bg:none; font-size:1.1rem;">üóë</button></div>` : ''}</div><div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">${statusBadge}${zimmetHtml}</div></div>`; 
        }).join('');
    }

    // Yardƒ±mcƒ± UI G√ºncellemeleri
    window.updateStats = (todayISO) => {
        let activeSet = new Set();
        window.globalState.tasks.forEach(t => {
            const s = t.startDate || window.parseDateStr(t.date).toISOString().split('T')[0];
            const e = t.endDate || window.parseDateStr(t.date).toISOString().split('T')[0];
            if (todayISO >= s && todayISO <= e) {
                if(Array.isArray(t.person)) t.person.forEach(p=>activeSet.add(p)); else activeSet.add(t.person);
            }
        });
        document.getElementById('stat-total').innerText=window.globalState.users.length; 
        document.getElementById('stat-active').innerText=activeSet.size; 
        document.getElementById('stat-idle').innerText=Math.max(0,window.globalState.users.length-activeSet.size);
    }

    window.loadDropdowns = () => {
        if(document.getElementById('p-manager')) document.getElementById('p-manager').innerHTML=window.globalState.users.map(u=>`<option>${u.name}</option>`).join('');
        if(document.getElementById('t-project-select')) document.getElementById('t-project-select').innerHTML=`<option value="">Se√ß</option>`+window.globalState.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        if(document.getElementById('c-person')) document.getElementById('c-person').innerHTML=window.globalState.users.map(u=>`<option value="${u.name}">${u.name}</option>`).join('');
        const fillMulti=(id,arr,k)=>{const el=document.getElementById(id);if(el)el.innerHTML=arr.map(i=>`<div class="ms-item"><input type="checkbox" value="${i[k]}">${i[k]}</div>`).join('')};
        fillMulti('ms-person',window.globalState.users,'name'); fillMulti('ms-device',window.globalState.devices,'name'); fillMulti('ms-plate',window.globalState.vehicles,'plate');
    }
    
    // Modal A√ß/Kapa
    window.openModal = (isoDate) => { 
        window.globalState.selectedDateStr = isoDate; 
        document.getElementById('modalDateText').innerText = isoDate.split('-').reverse().join('.'); 
        if(!window.globalState.editingTaskId) {
           document.getElementById('t-start-date').value = isoDate;
           document.getElementById('t-end-date').value = isoDate;
       }
       window.openModalLogic(isoDate); 
       document.querySelector('#taskModal').style.display = 'flex'; 
    }
    window.closeModal = () => { document.querySelector('#taskModal').style.display = 'none'; window.cancelTaskEdit(); }
    
    window.openModalLogic = (isoDate) => {
        const dt = window.globalState.tasks.filter(t => {
            const s = t.startDate || window.parseDateStr(t.date).toISOString().split('T')[0];
            const e = t.endDate || window.parseDateStr(t.date).toISOString().split('T')[0];
            return isoDate >= s && isoDate <= e;
        });
        document.getElementById('dayTaskList').innerHTML = dt.length ? dt.map(t => {
            const pStr = Array.isArray(t.person) ? t.person.join(", ") : t.person;
            const rangeStr = (t.startDate && t.endDate) ? `<br><small>üìÖ ${t.startDate.split('-').reverse().join('.')} - ${t.endDate.split('-').reverse().join('.')}</small>` : '';
            return `<div style="padding:10px; background:#f9f9f9; border-radius:8px; margin-bottom:5px; border-left:4px solid #764ba2;">
                <strong>${pStr}</strong><br>üìç ${t.projectName} ${rangeStr}
                ${window.globalState.userRole==='admin' ? `<div style="float:right;"><button onclick="editTask('${t.id}')" style="border:none; background:none; font-size:1.1rem; margin-right:5px; cursor:pointer;" title="D√ºzenle">‚úé</button><button onclick="delTask('${t.id}')" style="color:red; border:none; background:none; font-size:1.1rem; cursor:pointer;" title="Sil">üóë</button></div>` : ''}
            </div>`;
        }).join('') : 'Bu tarihte g√∂rev yok.';
    }
</script>

<script type="module">
    // Ara√ß ƒ∞≈ülemleri
    window.addVehicle = async () => {
        const p=document.getElementById('v-plate').value; if(!p)return; 
        await window.fs.addDoc(window.fs.collection(window.db,"vehicles"),{plate:p,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value,currentHolder:null}); 
        window.showToast("Ara√ß Eklendi"); window.resetVehicleForm();
    }
    window.updateVehicleDB = async () => {
        await window.fs.updateDoc(window.fs.doc(window.db,"vehicles",window.globalState.editingVehicleId),{plate:document.getElementById('v-plate').value,info:document.getElementById('v-info').value,inspectionDate:document.getElementById('v-inspection').value}); 
        window.showToast("Ara√ß G√ºncellendi"); window.resetVehicleForm();
    }
    window.editVehicle=(id)=>{
        const v=window.globalState.vehicles.find(x=>x.id===id); if(!v)return; 
        document.getElementById('v-plate').value=v.plate; document.getElementById('v-info').value=v.info; document.getElementById('v-inspection').value=v.inspectionDate||""; 
        window.globalState.editingVehicleId=id; document.getElementById('vehicleFormTitle').innerText="D√ºzenle"; document.getElementById('btn-v-save').style.display='none'; document.getElementById('btn-v-update').style.display='block'; document.getElementById('btn-v-cancel').style.display='block';
    }
    window.cancelVehicleEdit = () => { window.resetVehicleForm(); }
    window.resetVehicleForm = () => {
        window.globalState.editingVehicleId=null; document.getElementById('v-plate').value=""; document.getElementById('v-info').value=""; document.getElementById('v-inspection').value=""; 
        document.getElementById('vehicleFormTitle').innerText="Yeni Ara√ß Ekle"; document.getElementById('btn-v-save').style.display='block'; document.getElementById('btn-v-update').style.display='none'; document.getElementById('btn-v-cancel').style.display='none';
    }
    window.deleteVehicle = async (id) => { if(confirm("Sil?")) { await window.fs.deleteDoc(window.fs.doc(window.db,"vehicles",id)); window.showToast("Silindi"); }}

    // Cihaz ƒ∞≈ülemleri
    window.uploadPDF = async (file) => {
        if (!file) return null;
        try {
            const fName = new Date().getTime() + '_' + file.name;
            const storageRef = window.fbStorage.ref(window.storage, 'calibration_docs/' + fName);
            await window.fbStorage.uploadBytes(storageRef, file);
            return await window.fbStorage.getDownloadURL(storageRef); 
        } catch (e) {
            console.error("Y√ºkleme hatasƒ±:", e); alert("Dosya y√ºklenirken hata olu≈ütu!"); return null;
        }
    }
    window.addDevice = async () => {
        const n = document.getElementById('d-name').value;
        const fileInput = document.getElementById('d-file').files[0];
        if (!n) return window.showToast("Cihaz adƒ± zorunlu", "error");
        const btn = document.getElementById('btn-d-save'); btn.innerText = "Y√ºkleniyor..."; btn.disabled = true;
        let pdfUrl = null;
        if (fileInput) { pdfUrl = await window.uploadPDF(fileInput); }
        await window.fs.addDoc(window.fs.collection(window.db, "devices"), {
            name: n, serial: document.getElementById('d-serial').value, calib: document.getElementById('d-calib').value, pdfUrl: pdfUrl, currentHolder: null
        });
        window.showToast("Cihaz Eklendi"); document.getElementById('d-name').value = ""; document.getElementById('d-serial').value = ""; document.getElementById('d-calib').value = ""; document.getElementById('d-file').value = ""; btn.innerText = "Ekle"; btn.disabled = false;
    }
    // (Cihaz g√ºncelleme ve silme fonksiyonlarƒ± benzer ≈üekilde buraya eklenir, yer darlƒ±ƒüƒ± sebebiyle kƒ±saltƒ±yorum)

    // G√∂rev ve Zimmet
    window.saveTask = async () => {
        const btn = document.getElementById('btn-save-task'); btn.disabled = true; 
        try {
            // Checkbox deƒüerlerini al
            const getVals = (id) => Array.from(document.querySelectorAll(`#${id} input:checked`)).map(i=>i.value);
            const per = getVals('ms-person'), dev = getVals('ms-device'), plate = getVals('ms-plate');
            const projVal = document.getElementById('t-project-select').value;
            const sDate = document.getElementById('t-start-date').value;
            const eDate = document.getElementById('t-end-date').value;
            const loc = document.getElementById('t-loc').value;

            if(!projVal || per.length===0 || !sDate || !eDate) { window.showToast("Eksik bilgi!", "error"); btn.disabled = false; return; }
            
            // Veritabanƒ±na kaydet
            const projName = document.getElementById('t-project-select').options[document.getElementById('t-project-select').selectedIndex].text;
            const taskData = { startDate: sDate, endDate: eDate, person: per, projectName: projName, projectId: projVal, location: loc, device: dev, plate: plate };
            
            if (window.globalState.editingTaskId) {
                await window.fs.updateDoc(window.fs.doc(window.db, "tasks", window.globalState.editingTaskId), taskData);
                window.showToast("G√∂rev g√ºncellendi!", "success"); window.cancelTaskEdit(); 
            } else {
                await window.fs.addDoc(window.fs.collection(window.db, "tasks"), taskData);
                window.showToast("G√∂rev atandƒ±!", "success");
            }
        } catch (error) { console.error(error); window.showToast("Hata: " + error.message, "error"); } finally { btn.disabled = false; }
    }
</script>

<script type="module">
    // Kimlik Doƒürulama Dinleyicisi
    window.fbAuth.onAuthStateChanged(window.auth, async (user) => {
        if (user) {
            const userDoc = await window.fs.getDoc(window.fs.doc(window.db, "users", user.email));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                window.globalState.currentUser = userData; 
                window.globalState.userRole = userData.role;
                
                document.getElementById('welcomeUser').innerText = userData.name.split(' ')[0];
                document.getElementById('profileName').innerText = userData.name;
                document.getElementById('profileRole').innerText = userData.title || (userData.role === 'admin' ? 'Y√∂netici' : 'Personel');
                document.getElementById('profileAvatar').innerText = userData.name.charAt(0);
                
                // Yetkilendirme
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = (userData.role === 'admin') ? 'block' : 'none');
                document.querySelectorAll('.nav-item.admin-only').forEach(el => el.style.display = (userData.role === 'admin') ? 'flex' : 'none');
                
                startListeners();
            } else {
                alert("Kullanƒ±cƒ± kaydƒ± yok."); window.fbAuth.signOut(window.auth).then(()=> window.location.href="login.html");
            }
        } else {
            window.location.href = "login.html";
        }
    });

    function startListeners() {
        // Ara√ßlar
        window.fs.onSnapshot(window.fs.collection(window.db, "vehicles"), (s) => { 
            window.globalState.vehicles=[]; s.docs.forEach(d=>window.globalState.vehicles.push({id:d.id, ...d.data()})); 
            window.renderVehicleList(); window.loadDropdowns(); 
        });
        // Projeler
        window.fs.onSnapshot(window.fs.collection(window.db, "projects"), (s) => { 
            window.globalState.projects=[]; s.docs.forEach(d=>window.globalState.projects.push({id:d.id, ...d.data()})); 
            window.renderProjects(); window.loadDropdowns(); 
        });
        // Kullanƒ±cƒ±lar
        window.fs.onSnapshot(window.fs.collection(window.db, "users"), (s) => { 
            window.globalState.users=[]; s.docs.forEach(d=>window.globalState.users.push(d.data())); 
            // Kullanƒ±cƒ± listesi render fonksiyonu buraya
            window.loadDropdowns(); 
        });
        // G√∂revler
        window.fs.onSnapshot(window.fs.collection(window.db, "tasks"), (snapshot) => {
            window.globalState.tasks=[]; snapshot.docs.forEach(d=>window.globalState.tasks.push({id:d.id, ...d.data()}));
            window.renderCalendar();
            window.updateStats(new Date().toISOString().split('T')[0]); 
            window.renderDeviceList(); 
            window.renderVehicleList(); 
        });
        // Cihazlar
        window.fs.onSnapshot(window.fs.collection(window.db, "devices"), (s) => {
            window.globalState.devices=[]; s.docs.forEach(d=>window.globalState.devices.push({id:d.id, ...d.data()}));
            window.renderDeviceList(); window.loadDropdowns();
        });
    }
    
    // Tab Deƒüi≈ütirme
    window.switchTab = (tab) => { 
        document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); 
        document.getElementById('view-'+tab).classList.add('active'); 
        event.currentTarget.classList.add('active'); 
    }
    
    // √áƒ±kƒ±≈ü
    window.handleLogout = () => { window.fbAuth.signOut(window.auth).then(() => { window.location.href = "login.html"; }); };
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').then(function(registration) {
        console.log('PWA Hazƒ±r: ', registration.scope);
      }, function(err) {
        console.log('PWA Hatasƒ±: ', err);
      });
    });
  }
</script>

</body>
</html>